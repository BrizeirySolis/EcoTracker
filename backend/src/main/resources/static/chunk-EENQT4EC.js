import{Sa as U,Za as d,a as s,b as a,e as c,g as u,i as l,k as p,r as h,u as m,x as i}from"./chunk-HBL3S35I.js";var g={production:!0,apiUrl:"/api"};var v=class o{constructor(t,e){this.http=t;this.router=e;let r=localStorage.getItem("currentUser");this.currentUserSubject=new u(r?JSON.parse(r):null),this.currentUser=this.currentUserSubject.asObservable(),console.log("AuthService iniciado, usuario almacenado:",r?JSON.parse(r)?.username:"ninguno")}API_URL=`${g.apiUrl}/auth`;currentUserSubject;currentUser;scoreCache=null;CACHE_DURATION=5e3;get currentUserValue(){return this.currentUserSubject.value}signup(t){return this.http.post(`${this.API_URL}/signup`,t)}login(t){return console.log("Intentando login con:",t.username),this.http.post(`${this.API_URL}/signin`,t).pipe(p(e=>{if(console.log("Respuesta completa del login:",e),!e.token)throw console.error("No se recibi\xF3 token en la respuesta"),new Error("No se recibi\xF3 un token v\xE1lido del servidor");let r=e.token.startsWith("Bearer ")?e.token:`Bearer ${e.token}`;console.log("Token formateado: "+r.substring(0,20)+"...");let n={id:e.id,username:e.username,email:e.email,name:e.name||e.username,puntuacion:0,roles:e.roles,token:r};return localStorage.setItem("currentUser",JSON.stringify(n)),console.log("Usuario guardado en localStorage"),this.currentUserSubject.next(n),this.invalidateScoreCache(),n}))}logout(){localStorage.removeItem("currentUser"),this.currentUserSubject.next(null),console.log("Usuario desconectado"),this.scoreCache=null,this.router.navigate(["/login"])}isLoggedIn(){let t=this.currentUserValue;return!!t&&!!t.token}refreshToken(){return new c(t=>{t.next(null),t.complete()})}getUserScore(){let t=Date.now();return this.scoreCache&&t-this.scoreCache.timestamp<this.CACHE_DURATION?(console.log("Devolviendo puntuaci\xF3n desde cach\xE9:",this.scoreCache.value),l({message:"Puntuaci\xF3n obtenida desde cach\xE9",puntuacion:this.scoreCache.value})):(console.log("Obteniendo puntuaci\xF3n desde el servidor..."),this.http.get(`${this.API_URL}/user/score`).pipe(h(e=>{this.scoreCache={value:e.puntuacion,timestamp:t},console.log("Puntuaci\xF3n almacenada en cach\xE9:",e.puntuacion)})))}updateUserScore(t){let e=this.currentUserValue;if(e){let r=a(s({},e),{puntuacion:t});localStorage.setItem("currentUser",JSON.stringify(r)),this.currentUserSubject.next(r),this.scoreCache={value:t,timestamp:Date.now()}}}getCurrentUserScore(){return this.currentUserValue?.puntuacion||0}invalidateScoreCache(){this.scoreCache=null,console.log("Cach\xE9 de puntuaci\xF3n invalidado")}static \u0275fac=function(e){return new(e||o)(i(U),i(d))};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{g as a,v as b};
