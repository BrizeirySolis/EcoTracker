import{Da as E,Ea as I,Qa as $,a as d,b as p,d as f,e as m,f as M,h as u,i as s,j as i,k as v,l as o,o as c,r as b,u as g}from"./chunk-4HKD5D5B.js";var P=class h{constructor(e){this.http=e}API_URL=`${$.apiUrl}/metas`;metasSubject=new M([]);filteredMetasCache={};metas$=this.metasSubject.asObservable();dataLoaded=!1;consumptionUpdatedSource=new m;consumptionUpdated$=this.consumptionUpdatedSource.asObservable();notifyConsumptionUpdated(e){this.consumptionUpdatedSource.next(e)}refreshMultipleMetas(e){if(!e||e.length===0)return u([]);let t=e.map(r=>this.refreshMetaProgress(r.id).pipe(o(a=>(console.error(`Error al actualizar meta ${r.id}:`,a),u(r)))));return v(t)}getAllMetas(e=!1,t){if(t&&t!==""){if(!e&&this.filteredMetasCache[t])return new f(a=>{a.next(this.filteredMetasCache[t]),a.complete()});let r=new E().set("tipo",t);return this.http.get(this.API_URL,{params:r}).pipe(i(a=>this.processMetasDateFields(a)),c(a=>{this.filteredMetasCache[t]=a}),o(a=>(console.error("Error fetching filtered metas:",a),s(()=>new Error("Error al cargar las metas. Por favor, int\xE9ntalo de nuevo.")))))}else return this.dataLoaded&&!e?this.metas$:this.http.get(this.API_URL).pipe(i(r=>this.processMetasDateFields(r)),c(r=>{this.metasSubject.next(r),this.dataLoaded=!0}),o(r=>(console.error("Error fetching all metas:",r),s(()=>new Error("Error al cargar las metas. Por favor, int\xE9ntalo de nuevo.")))))}getMetaById(e){return e===void 0||isNaN(e)||e<=0?(console.error("ID de meta inv\xE1lido:",e),s(()=>new Error("ID de meta inv\xE1lido. Por favor, intente nuevamente con un ID v\xE1lido."))):this.http.get(`${this.API_URL}/${e}`).pipe(i(t=>this.processMetaDateFields(t)),o(t=>(console.error(`Error fetching meta ID ${e}:`,t),s(()=>new Error("Error al cargar la meta solicitada. Por favor, int\xE9ntalo de nuevo.")))))}createMeta(e){return this.http.post(this.API_URL,e).pipe(i(t=>this.processMetaDateFields(t)),c(t=>{let r=this.metasSubject.value;this.metasSubject.next([t,...r]),this.filteredMetasCache={}}),o(t=>(console.error("Error creating meta:",t),s(()=>new Error("Error al crear la meta. Por favor, int\xE9ntalo de nuevo.")))))}updateMeta(e,t){return this.http.put(`${this.API_URL}/${e}`,t).pipe(i(r=>this.processMetaDateFields(r)),c(r=>{let a=this.metasSubject.value,l=a.findIndex(n=>n.id===r.id);if(l!==-1){let n=[...a];n[l]=r,this.metasSubject.next(n)}this.filteredMetasCache={}}),o(r=>(console.error(`Error updating meta ID ${e}:`,r),s(()=>new Error("Error al actualizar la meta. Por favor, int\xE9ntalo de nuevo.")))))}updateMetaProgress(e,t){return this.http.patch(`${this.API_URL}/${e}/progreso`,{valorActual:t}).pipe(i(r=>this.processMetaDateFields(r)),c(r=>{let a=this.metasSubject.value,l=a.findIndex(n=>n.id===r.id);if(l!==-1){let n=[...a];n[l]=r,this.metasSubject.next(n)}this.filteredMetasCache={}}),o(r=>(console.error(`Error updating meta progress ${e}:`,r),s(()=>new Error("Error al actualizar el progreso. Por favor, int\xE9ntalo de nuevo.")))))}deleteMeta(e){return this.http.delete(`${this.API_URL}/${e}`).pipe(c(()=>{let r=this.metasSubject.value.filter(a=>a.id!==e);this.metasSubject.next(r),this.filteredMetasCache={}}),o(t=>(console.error(`Error deleting meta ID ${e}:`,t),s(()=>new Error("Error al eliminar la meta. Por favor, int\xE9ntalo de nuevo.")))))}processMetaDateFields(e){return p(d({},e),{fechaInicio:e.fechaInicio?new Date(e.fechaInicio):new Date,fechaFin:e.fechaFin?new Date(e.fechaFin):new Date,createdAt:e.createdAt?new Date(e.createdAt):void 0})}processMetasDateFields(e){return e.map(t=>this.processMetaDateFields(t))}resetCache(){this.dataLoaded=!1,this.filteredMetasCache={}}getMetaRecommendations(e){return this.http.get(`${this.API_URL}/recomendaciones/${e}`).pipe(o(t=>(console.error(`Error fetching recommendations for ${e}:`,t),s(()=>new Error("Error al obtener recomendaciones. Utilizando valores predeterminados.")))))}refreshMetaProgress(e){return this.http.get(`${this.API_URL}/${e}/refresh`).pipe(i(t=>this.processMetaDateFields(t)),c(()=>{this.resetCache()}),o(t=>(console.error(`Error refreshing meta progress ${e}:`,t),s(()=>new Error("Error al actualizar el progreso. Por favor, int\xE9ntalo de nuevo.")))))}refreshAllMetas(e){let t=`${this.API_URL}/refresh-all`;return e&&e!==""&&(t+=`?tipo=${e}`),this.http.get(t)}static \u0275fac=function(t){return new(t||h)(g(I))};static \u0275prov=b({token:h,factory:h.\u0275fac,providedIn:"root"})};export{P as a};
