import{Aa as E,Ba as D,Na as h,a as b,b as B,d as g,f as A,i as n,j as s,l as c,o as l,r as v,u as C}from"./chunk-VNDPJNBL.js";var P={plantacion:[{nombre:"especie",etiqueta:"Especie de \xE1rbol",tipo:"texto",requerido:!0,placeholder:"Ej. Pino, Encino, Sauce"},{nombre:"cantidad",etiqueta:"Cantidad plantada",tipo:"numero",requerido:!0}],reciclaje:[{nombre:"material",etiqueta:"Tipo de material",tipo:"seleccion",opciones:["Pl\xE1stico","Papel","Vidrio","Metal","Electr\xF3nicos","Otro"],requerido:!0},{nombre:"cantidad",etiqueta:"Cantidad aproximada (kg)",tipo:"numero",requerido:!1}],limpieza:[{nombre:"ubicacion",etiqueta:"Lugar de limpieza",tipo:"texto",requerido:!0,placeholder:"Ej. Parque municipal, Playa, R\xEDo"},{nombre:"area",etiqueta:"\xC1rea cubierta (m\xB2)",tipo:"numero",requerido:!1}],educacion:[{nombre:"audiencia",etiqueta:"Tipo de audiencia",tipo:"texto",requerido:!0,placeholder:"Ej. Estudiantes, Comunidad, Empleados"},{nombre:"participantes",etiqueta:"N\xFAmero de participantes",tipo:"numero",requerido:!1}]},p={plantacion:"Plantaci\xF3n",reciclaje:"Reciclaje",conservacion:"Conservaci\xF3n",educacion:"Educaci\xF3n Ambiental",ahorro:"Ahorro Energ\xE9tico",consumo:"Consumo Responsable",limpieza:"Limpieza Ambiental",otro:"Otro"};var I=class u{constructor(e){this.http=e}API_URL=`${h.apiUrl}/bitacoras`;bitacorasSubject=new A([]);filteredBitacorasCache={};bitacoras$=this.bitacorasSubject.asObservable();dataLoaded=!1;getCategorias(){return this.http.get(`${this.API_URL}/categorias`).pipe(c(e=>(console.error("Error fetching categor\xEDas:",e),new g(t=>{t.next(p),t.complete()}))))}getAllBitacoras(e=!1,t){if(console.log("\u2B50 getAllBitacoras - categoria:",t,"forceRefresh:",e),t&&t!==""){console.log("\u{1F50D} Filtrando por categor\xEDa:",t);let a=Object.keys(p).includes(t);if(console.log("Categor\xEDa existe en modelo:",a,"Categor\xEDas disponibles:",Object.keys(p)),!e&&this.filteredBitacorasCache[t])return console.log("\u2705 Usando cach\xE9 para categor\xEDa:",t),new g(r=>{r.next(this.filteredBitacorasCache[t]),r.complete()});let i=new E().set("categoria",t);return console.log("\u{1F310} Petici\xF3n HTTP con par\xE1metros:",i.toString()),this.http.get(this.API_URL,{params:i}).pipe(s(r=>(console.log("\u{1F4CA} Datos recibidos del servidor:",r.length,"bit\xE1coras"),console.log("Categor\xEDas recibidas:",r.map(o=>o.categoria).join(", ")),this.processBitacorasDateFields(r))),l(r=>{this.filteredBitacorasCache[t]=r,console.log("\u{1F4BE} Guardado en cach\xE9 para categor\xEDa:",t)}),c(r=>(console.error("\u274C Error fetching filtered bit\xE1coras:",r),n(()=>new Error("Failed to load bit\xE1coras. Please try again later.")))))}else return console.log("\u{1F50D} Obteniendo todas las bit\xE1coras"),this.dataLoaded&&!e?(console.log("\u2705 Usando cach\xE9 general de bit\xE1coras"),this.bitacoras$):(console.log("\u{1F310} Petici\xF3n HTTP sin filtros"),this.http.get(this.API_URL).pipe(s(a=>(console.log("\u{1F4CA} Datos recibidos del servidor:",a.length,"bit\xE1coras"),this.processBitacorasDateFields(a))),l(a=>{this.bitacorasSubject.next(a),this.dataLoaded=!0,console.log("\u{1F4BE} Guardado en cach\xE9 general")}),c(a=>(console.error("\u274C Error fetching all bit\xE1coras:",a),n(()=>new Error("Failed to load bit\xE1coras. Please try again later."))))))}filtrarBitacorasPorCategoria(e,t){return!t||t===""?e:e.filter(a=>a.categoria===t)}getBitacoraById(e){return e===void 0||isNaN(e)||e<=0?(console.error("ID de bit\xE1cora inv\xE1lido:",e),n(()=>new Error("ID de bit\xE1cora inv\xE1lido. Por favor, intente nuevamente con un ID v\xE1lido."))):this.http.get(`${this.API_URL}/${e}`).pipe(s(t=>this.processBitacoraDateFields(t)),c(t=>(console.error(`Error fetching bit\xE1cora ID ${e}:`,t),n(()=>new Error("Failed to load the requested bit\xE1cora. Please try again later.")))))}createBitacora(e,t,a){let i=new FormData;return i.append("titulo",e.titulo),e.descripcion&&i.append("descripcion",e.descripcion),i.append("fecha",a||e.fecha.toISOString()),i.append("categoria",e.categoria),e.camposAdicionales&&i.append("camposAdicionales",JSON.stringify(e.camposAdicionales)),t&&i.append("imagen",t),this.http.post(this.API_URL,i).pipe(s(r=>this.processBitacoraDateFields(r)),l(r=>{let o=this.bitacorasSubject.value;this.bitacorasSubject.next([r,...o]),this.filteredBitacorasCache={}}),c(r=>(console.error("Error creating bit\xE1cora:",r),n(()=>new Error("Failed to create bit\xE1cora. Please try again later.")))))}updateBitacora(e,t,a,i){let r=new FormData;return r.append("titulo",t.titulo),t.descripcion&&r.append("descripcion",t.descripcion),r.append("fecha",i||t.fecha.toISOString()),r.append("categoria",t.categoria),t.camposAdicionales&&r.append("camposAdicionales",JSON.stringify(t.camposAdicionales)),a&&r.append("imagen",a),this.http.put(`${this.API_URL}/${e}`,r).pipe(s(o=>this.processBitacoraDateFields(o)),l(o=>{let m=this.bitacorasSubject.value,f=m.findIndex(d=>d.id===o.id);if(f!==-1){let d=[...m];d[f]=o,this.bitacorasSubject.next(d)}this.filteredBitacorasCache={}}),c(o=>(console.error(`Error updating bit\xE1cora ID ${e}:`,o),n(()=>new Error("Failed to update bit\xE1cora. Please try again later.")))))}deleteBitacora(e){return this.http.delete(`${this.API_URL}/${e}`).pipe(l(()=>{let a=this.bitacorasSubject.value.filter(i=>i.id!==e);this.bitacorasSubject.next(a),this.filteredBitacorasCache={}}),c(t=>(console.error(`Error deleting bit\xE1cora ID ${e}:`,t),n(()=>new Error("Failed to delete bit\xE1cora. Please try again later.")))))}getImageUrl(e){return e?e.startsWith("http")?e:`${h.apiUrl.replace("/api","")}/bitacoras-images/${e}`:""}processBitacoraDateFields(e){return B(b({},e),{fecha:e.fecha?new Date(e.fecha):new Date,createdAt:e.createdAt?new Date(e.createdAt):void 0})}processBitacorasDateFields(e){return e.map(t=>this.processBitacoraDateFields(t))}resetCache(){this.dataLoaded=!1,this.filteredBitacorasCache={}}static \u0275fac=function(t){return new(t||u)(C(D))};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};export{P as a,p as b,I as c};
