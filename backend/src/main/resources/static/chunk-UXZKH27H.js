import{Aa as E,Ga as I,Ma as D,a as g,b,d as v,g as a,h as c,j as s,m as d,p as A,s as l,ya as h,za as B}from"./chunk-GYKT2POG.js";var R={plantacion:[{nombre:"especie",etiqueta:"Especie de \xE1rbol",tipo:"texto",requerido:!0,placeholder:"Ej. Pino, Encino, Sauce"},{nombre:"cantidad",etiqueta:"Cantidad plantada",tipo:"numero",requerido:!0}],reciclaje:[{nombre:"material",etiqueta:"Tipo de material",tipo:"seleccion",opciones:["Pl\xE1stico","Papel","Vidrio","Metal","Electr\xF3nicos","Otro"],requerido:!0},{nombre:"cantidad",etiqueta:"Cantidad aproximada (kg)",tipo:"numero",requerido:!1}],limpieza:[{nombre:"ubicacion",etiqueta:"Lugar de limpieza",tipo:"texto",requerido:!0,placeholder:"Ej. Parque municipal, Playa, R\xEDo"},{nombre:"area",etiqueta:"\xC1rea cubierta (m\xB2)",tipo:"numero",requerido:!1}],educacion:[{nombre:"audiencia",etiqueta:"Tipo de audiencia",tipo:"texto",requerido:!0,placeholder:"Ej. Estudiantes, Comunidad, Empleados"},{nombre:"participantes",etiqueta:"N\xFAmero de participantes",tipo:"numero",requerido:!1}]},w={plantacion:"Plantaci\xF3n",reciclaje:"Reciclaje",conservacion:"Conservaci\xF3n",educacion:"Educaci\xF3n Ambiental",ahorro:"Ahorro Energ\xE9tico",consumo:"Consumo Responsable",limpieza:"Limpieza Ambiental",otro:"Otro"};var S=class u{constructor(e,t,i){this.http=e;this.authService=t;this.router=i}API_URL="http://localhost:8080/api/bitacoras";bitacorasSubject=new v([]);bitacoras$=this.bitacorasSubject.asObservable();dataLoaded=!1;getAuthHeaders(){let e=localStorage.getItem("currentUser");if(e){let t=JSON.parse(e);if(t&&t.token){let i=t.token.startsWith("Bearer ")?t.token:`Bearer ${t.token}`;return console.log("Usando token para solicitud: "+i.substring(0,20)+"..."),new h().set("Authorization",i)}}return console.warn("No se encontr\xF3 token para la solicitud"),new h}getCategorias(){let e=this.getAuthHeaders();return this.http.get(`${this.API_URL}/categorias`,{headers:e}).pipe(s(t=>(console.error("Error al obtener categor\xEDas:",t),t.status===401&&this.handleAuthError(),a(()=>new Error("Error al obtener categor\xEDas")))))}getAllBitacoras(e=!1,t){if(this.dataLoaded&&!e&&!t)return this.bitacoras$;let i=new B;t&&(i=i.set("categoria",t));let o=this.getAuthHeaders();return console.log("Solicitando bit\xE1coras con headers:",o),this.http.get(this.API_URL,{headers:o,params:i}).pipe(c(r=>this.processBitacorasDateFields(r)),d(r=>{t||(this.bitacorasSubject.next(r),this.dataLoaded=!0)}),s(r=>(console.error("Error al obtener bit\xE1coras:",r),r.status===401&&this.handleAuthError(),a(()=>new Error("Error al cargar las bit\xE1coras")))))}handleAuthError(){console.error("Error de autenticaci\xF3n detectado"),this.authService.logout(),this.router.navigate(["/login"],{queryParams:{returnUrl:this.router.url}})}getBitacoraById(e){if(e==null||isNaN(e)||e<=0)return console.error("ID de bit\xE1cora inv\xE1lido:",e,typeof e),a(()=>new Error("ID de bit\xE1cora inv\xE1lido"));let t=Number(e);return console.log("BitacoraService: Solicitando bit\xE1cora por ID:",t,typeof t),this.http.get(`${this.API_URL}/${t}`).pipe(c(i=>(console.log("BitacoraService: Bit\xE1cora obtenida del servidor:",i?.id,typeof i?.id),this.processBitacoraDateFields(i))),s(i=>(console.error(`Error fetching bit\xE1cora ID ${t}:`,i),a(()=>new Error("No se pudo cargar la bit\xE1cora solicitada. Por favor, intente de nuevo m\xE1s tarde.")))))}createBitacora(e,t,i){let o=new FormData;return o.append("titulo",e.titulo),e.descripcion&&o.append("descripcion",e.descripcion),o.append("fecha",i||e.fecha.toISOString()),o.append("categoria",e.categoria),e.camposAdicionales&&o.append("camposAdicionales",JSON.stringify(e.camposAdicionales)),t&&o.append("imagen",t),this.http.post(this.API_URL,o).pipe(c(r=>this.processBitacoraDateFields(r)),d(r=>{let n=this.bitacorasSubject.value;this.bitacorasSubject.next([r,...n])}),s(r=>(console.error("Error creating bit\xE1cora:",r),a(()=>new Error("Failed to create bit\xE1cora. Please try again later.")))))}updateBitacora(e,t,i,o){let r=new FormData;return r.append("titulo",t.titulo),t.descripcion&&r.append("descripcion",t.descripcion),r.append("fecha",o||t.fecha.toISOString()),r.append("categoria",t.categoria),t.camposAdicionales&&r.append("camposAdicionales",JSON.stringify(t.camposAdicionales)),i&&r.append("imagen",i),this.http.put(`${this.API_URL}/${e}`,r).pipe(c(n=>this.processBitacoraDateFields(n)),d(n=>{let m=this.bitacorasSubject.value,f=m.findIndex(p=>p.id===n.id);if(f!==-1){let p=[...m];p[f]=n,this.bitacorasSubject.next(p)}}),s(n=>(console.error(`Error updating bit\xE1cora ID ${e}:`,n),a(()=>new Error("Failed to update bit\xE1cora. Please try again later.")))))}deleteBitacora(e){let t=this.bitacorasSubject.value;return t.some(o=>o.id===e)||console.warn(`Attempting to delete bit\xE1cora ID ${e} which is not in local cache`),this.http.delete(`${this.API_URL}/${e}`).pipe(c(()=>!0),d(()=>{if(console.log(`Bit\xE1cora ID ${e} deleted successfully on server`),t.length>0){let o=t.filter(r=>r.id!==e);this.bitacorasSubject.next([...o]),console.log(`Local cache updated, removed bit\xE1cora ID ${e}`),this.dataLoaded=!0}}),s(o=>(console.error(`Error deleting bit\xE1cora ID ${e}:`,o),o.status===401||o.status===403?a(()=>new Error("Error de autorizaci\xF3n. Por favor, inicie sesi\xF3n nuevamente.")):a(()=>new Error("No se pudo eliminar la bit\xE1cora. Por favor, intente nuevamente.")))))}getImageUrl(e){return e?e.startsWith("http")?e:`http://localhost:8080/bitacoras-images/${e}`:""}processBitacoraDateFields(e){console.log("processBitacoraDateFields - ID antes de procesar:",e?.id,typeof e?.id);let t;return e?.id!==void 0&&e?.id!==null&&(t=Number(e.id),isNaN(t)&&(console.warn("ID de bit\xE1cora no es un n\xFAmero v\xE1lido:",e.id,typeof e.id),t=void 0)),console.log("processBitacoraDateFields - ID despu\xE9s de procesar:",t,typeof t),b(g({},e),{id:t,fecha:e.fecha?new Date(e.fecha):new Date,createdAt:e.createdAt?new Date(e.createdAt):void 0})}processBitacorasDateFields(e){return e.map(t=>this.processBitacoraDateFields(t))}static \u0275fac=function(t){return new(t||u)(l(E),l(D),l(I))};static \u0275prov=A({token:u,factory:u.\u0275fac,providedIn:"root"})};export{R as a,w as b,S as c};
